---
interface Props {
  dealView?: boolean;
}

const { dealView = false } = Astro.props;
---

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
  <div class="p-6 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        {dealView ? 'Deal Pipeline' : 'Lead Pipeline'}
      </h3>
      <div class="flex items-center gap-3">
        <select class="text-sm border border-gray-300 dark:border-gray-600 rounded-md px-3 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
          <option>All Sources</option>
          <option>Website</option>
          <option>Referral</option>
          <option>Cold Outreach</option>
          <option>Zapier</option>
        </select>
        <button class="btn-primary text-sm" id="newDealBtn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          New {dealView ? 'Deal' : 'Lead'}
        </button>
      </div>
    </div>
  </div>
  
  <div class="p-6">
    <div class="flex space-x-6 overflow-x-auto pb-4">
      <!-- New Leads Column -->
      <div class="kanban-column" data-column="new">
        <div class="kanban-header">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
              <h4 class="font-medium text-gray-900 dark:text-white">New Leads</h4>
              <span class="text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">12</span>
            </div>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="kanban-cards space-y-3">
          <!-- Lead Card 1 -->
          <div class="kanban-card" draggable="true" data-deal-id="1">
            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
              <div class="flex items-start justify-between mb-2">
                <h5 class="font-medium text-gray-900 dark:text-white text-sm">Acme Corp - Website Redesign</h5>
                <span class="text-xs text-gray-500">$25,000</span>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">John Smith • john@acmecorp.com</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <img src="/team/karson/CEO-Karson.png.jpg" alt="Owner" class="w-5 h-5 rounded-full" />
                  <span class="text-xs text-gray-500">Karson</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500">2 days ago</span>
                  <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Website</span>
                <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Hot</span>
              </div>
            </div>
          </div>
          
          <!-- Lead Card 2 -->
          <div class="kanban-card" draggable="true" data-deal-id="2">
            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
              <div class="flex items-start justify-between mb-2">
                <h5 class="font-medium text-gray-900 dark:text-white text-sm">TechStart Inc - QuickBooks Setup</h5>
                <span class="text-xs text-gray-500">$5,000</span>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Sarah Johnson • sarah@techstart.com</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <img src="/team/brandon/CRO-Brandon.jpg.jpg" alt="Owner" class="w-5 h-5 rounded-full" />
                  <span class="text-xs text-gray-500">Brandon</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500">1 hour ago</span>
                  <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded">Zapier</span>
                <span class="text-xs bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 px-2 py-1 rounded">Warm</span>
              </div>
            </div>
          </div>
          
          <!-- Lead Card 3 -->
          <div class="kanban-card" draggable="true" data-deal-id="3">
            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
              <div class="flex items-start justify-between mb-2">
                <h5 class="font-medium text-gray-900 dark:text-white text-sm">Global Industries - Full Payroll</h5>
                <span class="text-xs text-gray-500">$50,000</span>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Mike Chen • mike@globalind.com</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <img src="/team/allie/CAO-Allie.jpeg.jpg" alt="Owner" class="w-5 h-5 rounded-full" />
                  <span class="text-xs text-gray-500">Allie</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500">3 days ago</span>
                  <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-2 py-1 rounded">Referral</span>
                <span class="text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-1 rounded">Cold</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Contacted Column -->
      <div class="kanban-column" data-column="contacted">
        <div class="kanban-header">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
              <h4 class="font-medium text-gray-900 dark:text-white">Contacted</h4>
              <span class="text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">8</span>
            </div>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="kanban-cards space-y-3">
          <div class="kanban-card" draggable="true" data-deal-id="4">
            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
              <div class="flex items-start justify-between mb-2">
                <h5 class="font-medium text-gray-900 dark:text-white text-sm">RetailPlus - POS Integration</h5>
                <span class="text-xs text-gray-500">$15,000</span>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Lisa Wong • lisa@retailplus.com</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <img src="/team/karson/CEO-Karson.png.jpg" alt="Owner" class="w-5 h-5 rounded-full" />
                  <span class="text-xs text-gray-500">Karson</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500">5 hours ago</span>
                  <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="text-xs bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200 px-2 py-1 rounded">Cold Call</span>
                <span class="text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-2 py-1 rounded">Follow-up</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Qualified Column -->
      <div class="kanban-column" data-column="qualified">
        <div class="kanban-header">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
              <h4 class="font-medium text-gray-900 dark:text-white">Qualified</h4>
              <span class="text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">5</span>
            </div>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="kanban-cards space-y-3">
          <div class="kanban-card" draggable="true" data-deal-id="5">
            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
              <div class="flex items-start justify-between mb-2">
                <h5 class="font-medium text-gray-900 dark:text-white text-sm">MedTech Solutions - Compliance</h5>
                <span class="text-xs text-gray-500">$75,000</span>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Dr. Anna Rodriguez • anna@medtech.com</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <img src="/team/brandon/CRO-Brandon.jpg.jpg" alt="Owner" class="w-5 h-5 rounded-full" />
                  <span class="text-xs text-gray-500">Brandon</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500">1 day ago</span>
                  <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="text-xs bg-pink-100 dark:bg-pink-900 text-pink-800 dark:text-pink-200 px-2 py-1 rounded">Healthcare</span>
                <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Hot</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Proposal Column -->
      <div class="kanban-column" data-column="proposal">
        <div class="kanban-header">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-purple-400 rounded-full"></div>
              <h4 class="font-medium text-gray-900 dark:text-white">Proposal</h4>
              <span class="text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">3</span>
            </div>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="kanban-cards space-y-3">
          <div class="kanban-card" draggable="true" data-deal-id="6">
            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow cursor-pointer">
              <div class="flex items-start justify-between mb-2">
                <h5 class="font-medium text-gray-900 dark:text-white text-sm">EcoFriendly Corp - Green IT</h5>
                <span class="text-xs text-gray-500">$125,000</span>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">James Green • james@ecofriendly.com</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <img src="/team/allie/CAO-Allie.jpeg.jpg" alt="Owner" class="w-5 h-5 rounded-full" />
                  <span class="text-xs text-gray-500">Allie</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500">2 days ago</span>
                  <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Sustainability</span>
                <span class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-2 py-1 rounded">Enterprise</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Closed Won Column -->
      <div class="kanban-column" data-column="won">
        <div class="kanban-header">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 bg-green-400 rounded-full"></div>
              <h4 class="font-medium text-gray-900 dark:text-white">Closed Won</h4>
              <span class="text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">7</span>
            </div>
            <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="kanban-cards space-y-3">
          <div class="kanban-card" draggable="true" data-deal-id="7">
            <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow-md transition-shadow cursor-pointer border-l-4 border-l-green-500">
              <div class="flex items-start justify-between mb-2">
                <h5 class="font-medium text-gray-900 dark:text-white text-sm">FinanceFirst - Complete Setup</h5>
                <span class="text-xs text-green-600 font-semibold">$85,000</span>
              </div>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Robert Taylor • robert@financefirst.com</p>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <img src="/team/karson/CEO-Karson.png.jpg" alt="Owner" class="w-5 h-5 rounded-full" />
                  <span class="text-xs text-gray-500">Karson</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs text-gray-500">1 week ago</span>
                  <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">✓ Closed</span>
                <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Finance</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .kanban-column {
    @apply flex-shrink-0 w-80;
  }
  
  .kanban-card {
    @apply transition-transform;
  }
  
  .kanban-card:hover {
    @apply transform -translate-y-1;
  }
  
  .kanban-card.dragging {
    @apply opacity-50 rotate-2 scale-105;
  }
  
  .kanban-column.drag-over {
    @apply bg-blue-50 dark:bg-blue-900/20;
  }
  
  .kanban-cards {
    min-height: 200px;
    @apply p-2 rounded-lg border-2 border-dashed border-transparent;
  }
  
  .kanban-cards.drag-over {
    @apply border-blue-400 bg-blue-50 dark:bg-blue-900/20;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.kanban-card');
    const columns = document.querySelectorAll('.kanban-cards');
    
    let draggedElement: HTMLElement | null = null;
    
    // Drag start
    cards.forEach(card => {
      card.addEventListener('dragstart', (e) => {
        draggedElement = e.target as HTMLElement;
        draggedElement.classList.add('dragging');
        
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', draggedElement.outerHTML);
        }
      });
      
      card.addEventListener('dragend', () => {
        if (draggedElement) {
          draggedElement.classList.remove('dragging');
          draggedElement = null;
        }
      });
      
      // Click to open deal details
      card.addEventListener('click', (e) => {
        e.preventDefault();
        const dealId = card.getAttribute('data-deal-id');
        openDealModal(dealId);
      });
    });
    
    // Drag over and drop
    columns.forEach(column => {
      column.addEventListener('dragover', (e) => {
        e.preventDefault();
        column.classList.add('drag-over');
      });
      
      column.addEventListener('dragleave', () => {
        column.classList.remove('drag-over');
      });
      
      column.addEventListener('drop', (e) => {
        e.preventDefault();
        column.classList.remove('drag-over');
        
        if (draggedElement) {
          column.appendChild(draggedElement);
          
          // Update deal status in backend
          const dealId = draggedElement.getAttribute('data-deal-id');
          const newStatus = column.closest('.kanban-column')?.getAttribute('data-column');
          updateDealStatus(dealId, newStatus);
        }
      });
    });
    
    // Functions
    function openDealModal(dealId: string | null) {
      const modalContent = `
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Deal Details - ID: ${dealId}</h3>
            <button onclick="window.closeModal()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Name</label>
              <input type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" value="Acme Corp" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact Person</label>
              <input type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" value="John Smith" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
              <input type="email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" value="john@acmecorp.com" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
              <input type="tel" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" value="+1 (555) 123-4567" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deal Value</label>
              <input type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" value="$25,000" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
              <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                <option>High</option>
                <option>Medium</option>
                <option>Low</option>
              </select>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
              <textarea rows="4" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Add deal notes...">Interested in website redesign project. Mentioned budget of $25-30k. Follow up next week.</textarea>
            </div>
          </div>
          
          <div class="flex justify-between mt-6">
            <div class="flex gap-2">
              <button class="btn-secondary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Send Email
              </button>
              <button class="btn-secondary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"/>
                </svg>
                Schedule Meeting
              </button>
            </div>
            <div class="flex gap-2">
              <button onclick="window.closeModal()" class="btn-secondary">Cancel</button>
              <button class="btn-primary">Save Changes</button>
            </div>
          </div>
        </div>
      `;
      
      if (window.openModal) {
        window.openModal(modalContent);
      }
    }
    
    async function updateDealStatus(dealId: string | null, newStatus: string | null | undefined) {
      try {
        const response = await fetch('/api/deals/update-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            dealId,
            status: newStatus
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to update deal status');
        }
        
        console.log(`Deal ${dealId} moved to ${newStatus}`);
      } catch (error) {
        console.error('Error updating deal status:', error);
        // Could show a toast notification here
      }
    }
    
    // New deal button
    document.getElementById('newDealBtn')?.addEventListener('click', () => {
      openDealModal('new');
    });
  });
</script>
