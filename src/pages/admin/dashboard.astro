---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AdminDashboard from '../../components/AdminDashboard.astro';
import { requireAuth, requireRole, getCurrentUser } from '../../utils/auth';

// Check authentication and admin role
const authRedirect = requireAuth(Astro.request);
if (authRedirect) {
  return authRedirect;
}

const roleRedirect = requireRole(Astro.request, 'admin');
if (roleRedirect) {
  return roleRedirect;
}

// Get current user for dashboard
const currentUser = getCurrentUser(Astro.request);

// Ensure user exists (should always be true after auth checks)
if (!currentUser) {
  return new Response(null, {
    status: 302,
    headers: {
      'Location': '/crm?error=auth_required'
    }
  });
}

// Format user data for dashboard component
const dashboardUser = {
  id: currentUser.id,
  name: currentUser.name,
  email: currentUser.email,
  role: currentUser.role,
  avatar: currentUser.avatar,
  lastLogin: currentUser.lastLogin?.toISOString()
};

// Page metadata
const pageTitle = 'Admin Dashboard - KPS Group CRM';
const pageDescription = 'Comprehensive admin dashboard for managing KPS Group business operations, leads, and analytics.';
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
  noIndex={true}
>
  <AdminDashboard user={dashboardUser} />
  
  <!-- Admin Dashboard Styles -->
  <style>
    /* Ensure full viewport usage for dashboard */
    main {
      padding: 0 !important;
      margin: 0 !important;
      max-width: none !important;
    }
    
    /* Hide default header/footer for admin dashboard */
    .site-header,
    .site-footer {
      display: none;
    }
    
    /* Full screen dashboard */
    .admin-dashboard-container {
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
    }
  </style>
  
  <!-- Toast notification styles -->
  <style is:global>
    .toast-notification {
      position: fixed;
      right: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 1rem 1.5rem;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 1rem;
      max-width: 400px;
      border-left: 4px solid;
      animation: slideIn 0.3s ease;
    }
    
    .toast-success {
      border-left-color: #10b981;
      background: #f0fdf4;
    }
    
    .toast-error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .toast-info {
      border-left-color: #3b82f6;
      background: #eff6ff;
    }
    
    .toast-content {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
    }
    
    .toast-success .toast-content {
      color: #065f46;
    }
    
    .toast-error .toast-content {
      color: #991b1b;
    }
    
    .toast-info .toast-content {
      color: #1e40af;
    }
    
    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    
    .toast-close:hover {
      opacity: 1;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</BaseLayout>
